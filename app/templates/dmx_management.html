{% extends "base.html" %}

{% block title %}Gestione DMX{% endblock %}

{% block header %}
    <h1>Pagina di gestione DMX</h1>
{% endblock %}

{% block content %}
    <p>Stato: <span id="is_on"> . . . </span></p>
    <p>Fase corrente: <span id="current_phase_box"> . . . </span></p>
    <p>Messaggio: <span id="message_box"> . . . </span></p>
    <div>
        <button class="button" onclick="initialize()">Inizializza</button>
        <button class="button" onclick="reset()">Reset</button>
        <button class="button" onclick="stampa()">Stampa</button>
        <br>
        <button class="button" onclick="startLoop()">Avvia Loop</button>
        <button class="button" onclick="stopLoop()">Ferma Loop</button>
        <br>
        <button class="button" onclick="pauseDMX()">Pausa</button>
        <button class="button" onclick="resumeDMX()">Riprendi</button>        
    </div>
    <div>
        <button class="button" onclick="getDevicesInfo()">Info Dispositivi</button>
        <div id="devices_info">
            . . .
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Inizializza il sistema DMX
    async function initialize() {
        const response = await fetch('initialize_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Resetta il sistema DMX
    async function reset() {
        const response = await fetch('reset_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Avvia il loop di aggiornamento DMX
    async function startLoop() {
        const response = await fetch('start_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Ferma il loop di aggiornamento DMX
    async function stopLoop() {
        const response = await fetch('stop_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Mette in pausa il loop di aggiornamento DMX
    async function pauseDMX() {
        const response = await fetch('pause_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Riprende il loop di aggiornamento DMX
    async function resumeDMX() {
        const response = await fetch('resume_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Stampa il valore dei canali DMX sul file di log
    async function stampa() {
        const response = await fetch('stampa_DMX', { method: 'POST' });
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
    }

    // Ottiene la fase corrente
    async function getCurrentStatus() {
        const response = await fetch('get_current_status');
        const data = await response.json();
        document.getElementById('current_phase_box').textContent = data.current_phase;
        if (data.is_on) 
            document.getElementById('is_on').textContent = 'Acceso';
        else 
            document.getElementById('is_on').textContent = 'Spento';
    }
    
    // Aggiorna la fase corrente ogni 5 secondi
    setInterval(getCurrentStatus, 5000);

    // Ottiene le informazioni sui dispositivi
    async function getDevicesInfo() {
        const response = await fetch('get_devices_info');
        const data = await response.json();
        document.getElementById('message_box').textContent = data.message;
        document.getElementById('devices_info').innerHTML = jsonToTable(data).outerHTML;
    }

    function jsonToTable(json) {
        // Controlla se il JSON è un array di oggetti
        if (!Array.isArray(json)) {
            throw new Error('Il formato del JSON non è un array di oggetti.');
        }
    
        // Crea la tabella
        let table = document.createElement('table');
        table.border = 1;
    
        let thead = document.createElement('thead');
        let tbody = document.createElement('tbody');
    
        // Intestazioni della tabella
        let headerRow = document.createElement('tr');
        Object.keys(json[0]).forEach(key => {
            let th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
    
        // Righe del corpo della tabella
        json.forEach(item => {
            let row = document.createElement('tr');
            Object.values(item).forEach(value => {
                let td = document.createElement('td');
                td.textContent = value;
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
    
        return table;
    }

</script>
{% endblock %}
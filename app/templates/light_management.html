{% extends "base.html" %}

{% block title %}Gestione Luci{% endblock %}

{% block styles %}
<style>
    .slider-container {
        margin-bottom: 20px;
    }

    .color-preview {
        width: 200px;
        height: 200px;
        margin: 20px auto;
        border: 1px solid #000;
    }
</style>
{% endblock %}

{% block header %}
    <h1>Pagina di gestione Luci</h1>
{% endblock %}

{% block content %}
<form id="rgbForm">
    <div>
        <label for="deviceSelect">Seleziona Dispositivo:</label>
        <select id="deviceSelect">
            <!-- Le opzioni verranno popolate dinamicamente da JavaScript -->
        </select>
    </div>
    <div>
        <label for="phaseSelect">Seleziona Fase:</label>
        <select id="phaseSelect">
            <option value="ALBA">ALBA</option>
            <option value="GIORNO">GIORNO</option>
            <option value="SERA">SERA</option>
            <option value="NOTTE">NOTTE</option>
        </select>
    </div>
    <div class="slider-container">
        <label for="redSlider">Rosso:</label>
        <input type="range" id="redSlider" min="0" max="255" value="0">
        <span id="redValue">0</span>
    </div>
    <div class="slider-container">
        <label for="greenSlider">Verde:</label>
        <input type="range" id="greenSlider" min="0" max="255" value="0">
        <span id="greenValue">0</span>
    </div>
    <div class="slider-container">
        <label for="blueSlider">Blu:</label>
        <input type="range" id="blueSlider" min="0" max="255" value="0">
        <span id="blueValue">0</span>
    </div>
    <div class="slider-container">
        <label for="brightnessSlider">Luminosit√†:</label>
        <input type="range" id="brightnessSlider" min="0" max="255" value="0">
        <span id="brightnessValue">0</span>
    </div>
    <button type="button" id="testButton">Test</button>
    <button type="submit">Salva</button>
</form>

    <div class="color-preview" id="colorPreview"></div>

    
{% endblock %}

{% block scripts %}
<script>
    // Funzione per ottenere i dispositivi (esempio)
    async function get_lights_info() {
        const response = await fetch('get_lights_info');
        const data = await response.json();
        return data;
    }
    
    function get_devices() {
        return [
            { id: 'device1', name: 'Dispositivo 1' },
            { id: 'device2', name: 'Dispositivo 2' },
            { id: 'device3', name: 'Dispositivo 3' }
        ];
    }

    // Funzione per caricare i valori dal file di configurazione (esempio)
    function load_config(deviceId, phase) {
        // Simula il caricamento dei valori dal file di configurazione
        const config = {
            device1: { ALBA: { red: 100, green: 50, blue: 75 }, GIORNO: { red: 200, green: 100, blue: 150 } },
            device2: { ALBA: { red: 150, green: 75, blue: 100 }, GIORNO: { red: 250, green: 150, blue: 200 } }
        };
        return config[deviceId]?.[phase] || { red: 0, green: 0, blue: 0 };
    }

    // Funzione per salvare i valori nel file di configurazione (esempio)
    function save_config(deviceId, phase, red, green, blue) {
        console.log(`Salvataggio configurazione per ${deviceId} (${phase}): R=${red}, G=${green}, B=${blue}`);
        // Qui andrebbe il codice per salvare i valori nel file di configurazione
    }

    // Popola il menu dei dispositivi
    const deviceSelect = document.getElementById('deviceSelect');
    const devices = get_devices();
    devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = device.name;
        deviceSelect.appendChild(option);
    });

    // Aggiorna gli slider quando si seleziona un dispositivo e una fase
    const phaseSelect = document.getElementById('phaseSelect');
    const redSlider = document.getElementById('redSlider');
    const greenSlider = document.getElementById('greenSlider');
    const blueSlider = document.getElementById('blueSlider');
    const brightnessSlider = document.getElementById('brightnessSlider');
    const redValue = document.getElementById('redValue');
    const greenValue = document.getElementById('greenValue');
    const blueValue = document.getElementById('blueValue');
    const brightnessValue = document.getElementById('brightnessValue');

    // Elemento per visualizzare il colore selezionato
    const colorPreview = document.getElementById('colorPreview');

    function updateSliders() {
        const deviceId = deviceSelect.value;
        const phase = phaseSelect.value;
        const config = load_config(deviceId, phase);
        redSlider.value = config.red;
        greenSlider.value = config.green;
        blueSlider.value = config.blue;
        brightnessSlider.value = config.brightness;
        redValue.textContent = config.red;
        greenValue.textContent = config.green;
        blueValue.textContent = config.blue;
        brightnessValue.textContent = config.brightness;

        colorPreview.style.backgroundColor = `rgb(${config.red}, ${config.green}, ${config.blue})`;
    }

    deviceSelect.addEventListener('change', updateSliders);
    phaseSelect.addEventListener('change', updateSliders);

    // Aggiorna i valori visualizzati quando si muovono gli slider
    redSlider.addEventListener('input', () => {
        redValue.textContent = redSlider.value;
        colorPreview.style.backgroundColor = `rgb(${redSlider.value}, ${greenSlider.value}, ${blueSlider.value})`;
    });
    greenSlider.addEventListener('input', () => {
        greenValue.textContent = greenSlider.value;
        colorPreview.style.backgroundColor = `rgb(${redSlider.value}, ${greenSlider.value}, ${blueSlider.value})`;
    });
    blueSlider.addEventListener('input', () => {
        blueValue.textContent = blueSlider.value;
        colorPreview.style.backgroundColor = `rgb(${redSlider.value}, ${greenSlider.value}, ${blueSlider.value})`;
    });

    brightnessSlider.addEventListener('input', () => {
        brightnessValue.textContent = brightnessSlider.value;
    });

    // Bottone di test
    document.getElementById('testButton').addEventListener('click', () => {
        const deviceId = deviceSelect.value;
        const phase = phaseSelect.value;
        const red = redSlider.value;
        const green = greenSlider.value;
        const blue = blueSlider.value;
        console.log(`Test dispositivo ${deviceId} (${phase}): R=${red}, G=${green}, B=${blue}`);
        // Qui andrebbe il codice per testare il dispositivo con i valori attuali
    });

    // Submit del form
    document.getElementById('rgbForm').addEventListener('submit', (event) => {
        event.preventDefault();
        const deviceId = deviceSelect.value;
        const phase = phaseSelect.value;
        const red = redSlider.value;
        const green = greenSlider.value;
        const blue = blueSlider.value;
        save_config(deviceId, phase, red, green, blue);
        alert('Configurazione salvata con successo!');
    });

    // Fetch the lights and populate the dropdown
    function fetchLights() {
        fetch('get_lights')
            .then(response => response.json())
            .then(data => {
                const lightSelector = document.getElementById('lightSelector');
                lightSelector.innerHTML = '';

                data.lights.forEach(light => {
                    const option = document.createElement('option');
                    option.value = { name: light.name, subtype: light.subtype };
                    option.textContent = light.name;
                    lightSelector.appendChild(option);
                });
            });
    }

    fetchLights();
</script>
{% endblock %}